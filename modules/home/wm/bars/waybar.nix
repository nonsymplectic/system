{ config, lib, pkgs, ui, ... }:

let
  stripHash = s: lib.removePrefix "#" s;

  p = i: stripHash (builtins.elemAt ui.terminal.palette i);

  bg = stripHash ui.terminal.background;
  fg = stripHash ui.terminal.foreground;
in
{
  /* ============================================================
     Waybar (HM module)
     ------------------------------------------------------------
     Compositor-agnostic bar implementation.
     Generates:
       ~/.config/waybar/config
       ~/.config/waybar/style.css
     ============================================================ */

  home.packages = [
    pkgs.waybar
  ];

  xdg.configFile."waybar/config".text = ''
    {
      "layer": "top",
      "position": "top",
      "height": 26,
      "spacing": 8,
      "modules-left": ["sway/workspaces"],
      "modules-center": ["clock"],
      "modules-right": ["cpu", "memory", "pulseaudio", "network", "battery", "tray"]
    }
  '';

  xdg.configFile."waybar/style.css".text = ''
    /* Generated by Home Manager */

    * {
      font-family: "${ui.monoFont.family}";
      font-size: ${toString ui.monoFont.size}px;
    }

    window#waybar {
      background: #${bg};
      color: #${fg};
    }

    /* ANSI palette as CSS vars (for ricing consistency) */
    :root {
      --c0: #${p 0};  --c1: #${p 1};  --c2: #${p 2};  --c3: #${p 3};
      --c4: #${p 4};  --c5: #${p 5};  --c6: #${p 6};  --c7: #${p 7};
      --c8: #${p 8};  --c9: #${p 9};  --c10: #${p 10}; --c11: #${p 11};
      --c12: #${p 12}; --c13: #${p 13}; --c14: #${p 14}; --c15: #${p 15};
    }

    #workspaces button.focused { border-bottom: 2px solid var(--c4); }
    #clock { padding: 0 10px; }
  '';
}
