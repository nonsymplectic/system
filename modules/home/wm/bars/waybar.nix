{ config, lib, pkgs, ui, ... }:

let
  cfg = config.my.wm;

  stripHash = s: lib.removePrefix "#" s;

  # Token colors (expected to be like "#rrggbb" or "rrggbb"; we normalize)
  bg = stripHash ui.colors.background;
  fg = stripHash ui.colors.foreground;
  focus = stripHash ui.colors.focus;

  # ---- token-driven sizing ----
  s = ui.scale or 1.0;

  # integer rounding
  px = x: builtins.floor (x + 0.5);

  fontPx    = px (ui.monoFont.size * s);
  heightPx  = px (1.8 * fontPx);
  spacingPx = px (0.55 * fontPx);
  vPadPx    = px (0.20 * fontPx);
  hPadPx    = px (0.45 * fontPx);

  # Workspace button horizontal padding (thin buttons)
  wsHPadPx  = px (0.55 * fontPx);

  # ---- battery that hides when absent ----
  batScript = pkgs.writeShellScript "waybar-bat" ''
    set -eu
    bat="$(ls -d /sys/class/power_supply/BAT* 2>/dev/null | head -n1 || true)"
    [ -n "$bat" ] || exit 0
    cap="$(cat "$bat/capacity" 2>/dev/null || true)"
    [ -n "$cap" ] || exit 0
    printf 'BAT: %s%%\n' "$cap"
  '';
in
{
  /* ============================================================
     Waybar
     ============================================================ */

  config = lib.mkIf (cfg.enable && cfg.bar.enable && cfg.bar.backend == "waybar") {
    my.wm.bar.command = "waybar";

    home.packages = [ pkgs.waybar ];

    xdg.configFile."waybar/config".text = builtins.toJSON {
      layer = "top";
      position = cfg.bar.position;

      height = heightPx;
      spacing = spacingPx;

      modules-left = [ "sway/workspaces" ];
      modules-center = [ ];
      modules-right = [
        "network"
        "custom/bat"
        "disk"
        "memory"
        "clock"
      ];

      # --- NET ---
      network = {
        interval = 2;
        format-wifi = "NET: WIFI";
        format-ethernet = "NET: ETH";
        format-disconnected = "NET: --";
        tooltip-format-wifi = "{essid} ({signalStrength}%)\n{ipaddr}";
        tooltip-format-ethernet = "{ifname}\n{ipaddr}";
        tooltip-format-disconnected = "disconnected";
      };

      # --- BAT (hidden if no battery) ---
      "custom/bat" = {
        exec = "${batScript}";
        interval = 30;
        return-type = "plain";
        hide-empty-text = true;
        tooltip = false;
      };

      # --- /: used/total ---
      disk = {
        interval = 60;
        path = "/";
        format = "/: {used}/{total}";
        tooltip = false;
      };

      # --- MEM: used/total ---
      memory = {
        interval = 2;
        format = "MEM: {used}/{total}";
        tooltip = false;
      };

      # --- clock ---
      clock = {
        interval = 30;
        format = "{:%a %F %H:%M}";
        tooltip = false;
      };
    };

    xdg.configFile."waybar/style.css".text = ''
      /* Generated by Home Manager */

      * {
        font-family: "${ui.monoFont.family}";
        font-size: ${toString fontPx}px;
        border: none;
        border-radius: 0;
        box-shadow: none;
        min-height: 0;
      }

      @define-color bg    #${bg};
      @define-color fg    #${fg};
      @define-color focus #${focus};

      window#waybar {
        background: @bg;
        color: @fg;
        padding: ${toString vPadPx}px ${toString hPadPx}px;
      }

      /* ----------------------------
         Workspaces (thin full-height)
         ---------------------------- */

      #workspaces {
        background: transparent;
      }

      #workspaces button {
        background: @bg;
        color: @fg;
        padding: 0 ${toString wsHPadPx}px;
        margin: 0;
        min-height: 0;
      }

      #workspaces button.focused {
        background: @focus;
        color: @bg;
      }

      /* optional: remove hover styling that some themes inject */
      #workspaces button:hover {
        background: @focus;
        color: @bg;
      }

      /* ----------------------------
         RHS blocks and separators
         ---------------------------- */

      #network, #custom-bat, #disk, #memory, #clock {
        padding: 0;
        margin: 0;
      }

      .modules-right > widget:not(:last-child)::after {
        content: " |";
        color: @fg;
        padding-left: ${toString (px (0.35 * fontPx))}px;
      }
    '';
  };
}
